<%- contentFor("Embed Builder") %>
<section
  x-data="{
    channels: <%= channels ? JSON.stringify(channels) : '[]' %>,
    selectedChannel: '',
    formData: {
      embed_title: `<%= settings.embed.title || '' %>`,
      embed_description: `<%= settings.embed.description ? settings.embed.description.replace(/\\n/g, '\n') : '' %>`,
      embed_color: `<%= settings.embed.color || '#2f3136' %>`,
      embed_fields: <%= JSON.stringify(settings.embed.fields || []) %>,
      embed_footer: `<%= settings.embed.footer?.text || '' %>`,
      embed_footer_icon: `<%= settings.embed.footer?.iconURL || '' %>`,
      embed_thumbnail: `<%= settings.embed.thumbnail || '' %>`,
      embed_image: `<%= settings.embed.image || '' %>`,
      embed_author: `<%= settings.embed.author?.name || '' %>`,
      embed_author_icon: `<%= settings.embed.author?.iconURL || '' %>`,
      embed_timestamp: <%= settings.embed.timestamp ? 'true' : 'false' %>
    },
    addField() {
      if (this.formData.embed_fields.length < 25) {
        this.formData.embed_fields.push({ name: 'Nuevo Campo', value: 'Valor', inline: true });
      }
    },
    removeField(idx) {
      this.formData.embed_fields.splice(idx, 1);
    },
    saving: false,
    async submitForm(action) {
      this.saving = true;
      try {
        const response = await fetch(window.location.href, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...this.formData,
            action: action,
            target_channel: this.selectedChannel // Enviamos el canal seleccionado
          })
        });
        if (!response.ok) throw new Error('Failed to update');
        Alpine.store('toast').show('Configuración guardada correctamente', 'success');
        if(action === 'embed_reset') window.location.reload();
      } catch (error) {
        Alpine.store('toast').show('Error al guardar la configuración', 'error');
      }
      this.saving = false;
    }
  }"
  class="grid grid-cols-1 gap-6 lg:grid-cols-2">

  <div class="border-border bg-bg-panel rounded-lg border p-6 shadow-sm">
    <h3 class="text-text mb-4 text-lg font-bold">Editor de Contenido</h3>
    
    <div class="space-y-4">
      <div class="bg-bg-interactive rounded-lg border border-primary/20 p-4 mb-6">
        <label class="text-primary mb-1 block text-sm font-bold uppercase tracking-wider">Enviar a Discord</label>
        <div class="flex gap-2">
          <select x-model="selectedChannel" class="focus:ring-primary border-border bg-bg-panel text-text w-full rounded-lg border p-2 text-sm">
            <option value="">Selecciona un canal...</option>
            <template x-for="ch in channels" :key="ch.id">
              <option :value="ch.id" x-text="'#' + ch.name"></option>
            </template>
          </select>
          <button 
            @click="submitForm('embed_send')" 
            :disabled="!selectedChannel || saving"
            class="bg-success disabled:opacity-50 rounded-lg px-4 py-2 text-xs font-bold text-white transition hover:opacity-80">
            ENVIAR
          </button>
        </div>
      </div>

      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="text-text mb-1 block text-sm font-semibold">Título</label>
          <input type="text" x-model="formData.embed_title" class="focus:ring-primary border-border bg-bg-interactive text-text w-full rounded-lg border p-2 text-sm">
        </div>
        <div>
          <label class="text-text mb-1 block text-sm font-semibold">Color Hex</label>
          <input type="color" x-model="formData.embed_color" class="border-border bg-bg-interactive h-10 w-full rounded-lg border p-1">
        </div>
      </div>

      <div>
        <label class="text-text mb-1 block text-sm font-semibold">Descripción</label>
        <textarea x-model="formData.embed_description" rows="4" class="focus:ring-primary border-border bg-bg-interactive text-text w-full rounded-lg border p-2 text-sm"></textarea>
      </div>

      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="text-text mb-1 block text-sm font-semibold">Nombre del Autor</label>
          <input type="text" x-model="formData.embed_author" class="focus:ring-primary border-border bg-bg-interactive text-text w-full rounded-lg border p-2 text-sm">
        </div>
        <div>
          <label class="text-text mb-1 block text-sm font-semibold">Icono Autor (URL)</label>
          <input type="text" x-model="formData.embed_author_icon" class="focus:ring-primary border-border bg-bg-interactive text-text w-full rounded-lg border p-2 text-sm">
        </div>
      </div>

      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="text-text mb-1 block text-sm font-semibold">Imagen Grande (URL)</label>
          <input type="text" x-model="formData.embed_image" class="focus:ring-primary border-border bg-bg-interactive text-text w-full rounded-lg border p-2 text-sm">
        </div>
        <div>
          <label class="text-text mb-1 block text-sm font-semibold">Thumbnail (URL)</label>
          <input type="text" x-model="formData.embed_thumbnail" class="focus:ring-primary border-border bg-bg-interactive text-text w-full rounded-lg border p-2 text-sm">
        </div>
      </div>

      <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
        <div>
          <label class="text-text mb-1 block text-sm font-semibold">Texto Footer</label>
          <input type="text" x-model="formData.embed_footer" class="focus:ring-primary border-border bg-bg-interactive text-text w-full rounded-lg border p-2 text-sm">
        </div>
        <div class="flex items-end pb-2">
          <label class="text-text flex cursor-pointer items-center gap-2 text-sm font-semibold">
            <input type="checkbox" x-model="formData.embed_timestamp" class="text-primary rounded border-gray-600 bg-gray-700">
            Mostrar Fecha (Timestamp)
          </label>
        </div>
      </div>

      <div class="border-border mt-4 border-t pt-4">
        <div class="mb-2 flex items-center justify-between">
          <label class="text-text text-sm font-semibold">Campos (Fields)</label>
          <button @click="addField()" type="button" class="text-primary text-xs font-bold hover:underline">+ Añadir Campo</button>
        </div>
        <div class="space-y-2">
          <template x-for="(field, index) in formData.embed_fields" :key="index">
            <div class="bg-bg-interactive rounded-lg border border-dashed border-gray-600 p-3">
              <div class="grid grid-cols-2 gap-2">
                <input type="text" x-model="field.name" placeholder="Nombre" class="bg-bg-panel text-text rounded border-none p-1 text-xs">
                <input type="text" x-model="field.value" placeholder="Valor" class="bg-bg-panel text-text rounded border-none p-1 text-xs">
              </div>
              <div class="mt-2 flex items-center justify-between">
                <label class="text-text-muted text-[10px]">
                  <input type="checkbox" x-model="field.inline"> En línea
                </label>
                <button @click="removeField(index)" class="text-error text-[10px] hover:underline">Eliminar</button>
              </div>
            </div>
          </template>
        </div>
      </div>

      <div class="mt-6 flex gap-2">
        <button @click="submitForm('embed_update')" :disabled="saving" class="bg-primary w-full rounded-lg py-2 text-sm font-bold text-white transition hover:opacity-80">
          <span x-show="!saving">Guardar Diseño</span>
          <span x-show="saving">Guardando...</span>
        </button>
        <button @click="submitForm('embed_reset')" class="bg-error w-1/3 rounded-lg py-2 text-sm font-bold text-white transition hover:opacity-80">
          Reset
        </button>
      </div>
    </div>
  </div>

  <div class="lg:sticky lg:top-4">
    <div class="mb-4">
        <h3 class="text-text text-lg font-bold">Previsualización</h3>
        <p class="text-text-muted text-xs">Vista previa en tiempo real del embed.</p>
    </div>
    <%- includePartial('embedPreview', { 
      channelName: "'#preview-canal'",
      content: "''", 
      embed: { 
        title: "formData.embed_title", 
        author: { 
          name: "formData.embed_author", 
          iconURL: "formData.embed_author_icon" 
        }, 
        description: "formData.embed_description", 
        color: "formData.embed_color", 
        fields: "formData.embed_fields", 
        footer: { 
          text: "formData.embed_footer", 
          iconURL: "formData.embed_footer_icon" 
        }, 
        thumbnail: "formData.embed_thumbnail", 
        image: "formData.embed_image", 
        timestamp: "formData.embed_timestamp" 
      } 
    }) %>
  </div>
</section>