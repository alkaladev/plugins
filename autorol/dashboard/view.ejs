<%- contentFor("Autorol") %>
<section
  x-data="{
    messages: <%= messages ? JSON.stringify(messages) : '[]' %>,
    channels: <%= channels ? JSON.stringify(channels) : '[]' %>,
    formData: {
      titulo: '',
      descripcion: '',
      color: '#5865F2'
    },
    saving: false,
    async submitForm() {
      this.saving = true;
      try {
        const response = await fetch(window.location.href, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            ...this.formData,
            action: 'create_message'
          })
        });
        if (!response.ok) throw new Error('Failed to create');
        Alpine.store('toast').show('<%=tr(`SETTINGS_SAVE`)%>', 'success');
        this.formData = { titulo: '', descripcion: '', color: '#5865F2' };
        location.reload();
      } catch (error) {
        Alpine.store('toast').show('<%=tr(`SETTINGS_SAVE_ERROR`)%>', 'error');
      } finally {
        this.saving = false;
      }
    }
  }"
  class="border-border bg-bg-panel rounded-lg border p-4 shadow-sm">
  
  <!-- Header -->
  <div class="mb-4">
    <h3 class="text-text text-lg font-semibold">üìù Crear nuevo Sistema</h3>
    <p class="text-text-muted text-sm font-normal">Crea un nuevo embed de asignaci√≥n de roles</p>
  </div>

  <!-- Form Grid -->
  <div class="grid gap-4 md:grid-cols-2 xl:grid-cols-3 mb-4">
    <!-- Title -->
    <div>
      <div class="mb-2">
        <label class="text-text text-sm font-semibold">T√≠tulo</label>
        <div class="text-text-muted text-sm font-normal">El t√≠tulo principal del embed</div>
      </div>
      <input
        x-model="formData.titulo"
        type="text"
        placeholder="ej: Elige tu rol"
        class="focus:ring-primary focus:border-primary border-border bg-bg-interactive text-text block w-full rounded-lg border p-2.5 text-sm"
        required />
    </div>

    <!-- Color -->
    <div>
      <div class="mb-2">
        <label class="text-text text-sm font-semibold">Color (Hexadecimal)</label>
        <div class="text-text-muted text-sm font-normal">ej: #5865F2</div>
      </div>
      <input
        x-model="formData.color"
        type="text"
        placeholder="#5865F2"
        class="focus:ring-primary focus:border-primary border-border bg-bg-interactive text-text block w-full rounded-lg border p-2.5 text-sm"
        pattern="^#[A-Fa-f0-9]{6}$" />
    </div>

    <!-- Spacer -->
    <div></div>
  </div>

  <!-- Description -->
  <div class="mb-4">
    <div class="mb-2">
      <label class="text-text text-sm font-semibold">Descripci√≥n</label>
      <div class="text-text-muted text-sm font-normal">El contenido principal del embed</div>
    </div>
    <textarea
      x-model="formData.descripcion"
      placeholder="Haz clic en los botones para obtener roles..."
      class="focus:ring-primary focus:border-primary border-border bg-bg-interactive text-text block w-full rounded-lg border p-2.5 text-sm"
      style="min-height: 100px;"
      required></textarea>
  </div>

  <!-- Embed Preview -->
  <div class="mb-4">
    <div class="mb-2">
      <label class="text-text text-sm font-semibold">üìã Vista previa</label>
    </div>
    <div class="bg-bg-interactive border-border border rounded-lg p-0 overflow-hidden">
      <!-- Discord Embed Style -->
      <div class="p-4" style="background-color: #2C2F33;">
        <!-- Empty state -->
        <template x-if="!formData.titulo && !formData.descripcion">
          <div class="text-text-muted text-sm text-center py-12">
            Rellena los campos para ver una vista previa
          </div>
        </template>

        <!-- Embed preview -->
        <template x-if="formData.titulo || formData.descripcion">
          <div class="embed-preview" style="border-left: 4px solid; border-left-color: var(--embed-color, #5865F2); padding-left: 12px;">
            <!-- Embed Title -->
            <div x-show="formData.titulo" x-text="formData.titulo" class="text-text font-semibold text-sm mb-2" :style="{ color: formData.color }"></div>
            
            <!-- Embed Description -->
            <div x-show="formData.descripcion" x-text="formData.descripcion" class="text-text-muted text-sm whitespace-pre-wrap leading-5"></div>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Sistemas Creados -->
  <template x-if="messages && messages.length > 0">
    <div class="mb-4">
      <div class="mb-2">
        <label class="text-text text-sm font-semibold">üìä Sistemas Creados</label>
      </div>
      <div class="grid gap-3">
        <template x-for="msg in messages" :key="msg.messageId">
          <div class="bg-bg-interactive border-border border rounded-lg p-3">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <div x-text="msg.title" class="text-text font-semibold text-sm mb-1"></div>
                <div x-text="msg.description" class="text-text-muted text-xs mb-2 line-clamp-2"></div>
                <div class="text-text-muted text-xs space-y-1">
                  <div>Botones: <strong x-text="(msg.buttons?.length || 0) + '/25'"></strong></div>
                  <div>ID: <code class="bg-bg-panel px-2 py-1 rounded text-xs font-mono" x-text="msg.messageId"></code></div>
                </div>
              </div>
              <button
                @click="if(confirm('¬øEliminar este sistema?')) fetch(window.location.href, { method: 'DELETE', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({messageId: msg.messageId, action: 'delete_message'}) }).then(() => location.reload())"
                class="bg-error hover:bg-error-dark text-white px-3 py-1 rounded text-sm font-medium ml-2 flex-shrink-0">
                Eliminar
              </button>
            </div>
          </div>
        </template>
      </div>
    </div>
  </template>

  <!-- Footer -->
  <div class="border-border mt-4 flex items-center justify-between border-t pt-3 sm:pt-6">
    <div>
      <button
        type="button"
        @click="formData = { titulo: '', descripcion: '', color: '#5865F2' }"
        class="text-text-muted hover:text-text text-sm font-medium transition-colors">
        Limpiar
      </button>
    </div>
    <div class="flex-shrink-0">
      <button
        type="button"
        @click="submitForm()"
        :disabled="saving || !formData.titulo || !formData.descripcion"
        :class="{'opacity-50': saving}"
        class="bg-primary hover:bg-primary-dark focus:ring-primary inline-flex items-center rounded-lg px-3 py-2 text-center text-sm font-medium text-white focus:outline-none focus:ring-4 disabled:cursor-not-allowed">
        <span x-show="!saving">Crear Sistema</span>
        <span x-show="saving">Guardando...</span>
      </button>
    </div>
  </div>
</section>
