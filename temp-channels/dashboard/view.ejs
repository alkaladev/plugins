<div class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 p-6">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center gap-3 mb-2">
                <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"></path>
                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2 1 1 0 000 2H3a1 1 0 00-1 1v10a1 1 0 001 1h14a1 1 0 001-1V6a1 1 0 00-1-1h-3a1 1 0 000-2 2 2 0 00-2 2v3H4V5zm12 5a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-3xl font-bold text-white">Canales Temporales</h1>
                    <p class="text-slate-400">Crea canales de voz din√°micos autom√°ticamente</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Panel Principal -->
            <div class="lg:col-span-2">
                <!-- Generadores -->
                <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 mb-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-white">Generadores</h2>
                        <button id="addGeneratorBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition">
                            + A√±adir
                        </button>
                    </div>
                    <div id="generatorsList" class="space-y-4">
                        <div class="text-center py-8 text-slate-400">Cargando...</div>
                    </div>
                </div>

                <!-- Canales Activos -->
                <div class="bg-slate-800 border border-slate-700 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-bold text-white">Canales Activos</h2>
                        <button id="refreshBtn" class="text-slate-400 hover:text-white">üîÑ</button>
                    </div>
                    <div id="activeChannelsList" class="space-y-3">
                        <div class="text-center py-8 text-slate-400">Cargando...</div>
                    </div>
                </div>
            </div>

            <!-- Panel de Info -->
            <div class="lg:col-span-1">
                <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 sticky top-6">
                    <h3 class="text-lg font-bold text-white mb-4">‚ÑπÔ∏è Informaci√≥n</h3>
                    <div class="space-y-4 text-sm text-slate-300">
                        <div>
                            <p class="font-bold mb-2">¬øC√≥mo funciona?</p>
                            <ul class="space-y-1 text-xs">
                                <li>‚Ä¢ Configura un canal generador</li>
                                <li>‚Ä¢ Se crea un canal temporal al conectarse</li>
                                <li>‚Ä¢ Se elimina cuando se vac√≠a</li>
                            </ul>
                        </div>
                        <div class="border-t border-slate-700 pt-4">
                            <p class="font-bold mb-2">Opciones</p>
                            <ul class="space-y-1 text-xs">
                                <li><strong>Prefijo:</strong> "Patrulla", "Squad", etc</li>
                                <li><strong>L√≠mite:</strong> M√°ximo de usuarios</li>
                                <li><strong>Categor√≠a:</strong> D√≥nde crearlos</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-slate-800 border border-slate-700 rounded-lg p-6 max-w-md w-full">
        <h3 id="modalTitle" class="text-xl font-bold text-white mb-4">Nuevo Generador</h3>
        <form id="generatorForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Canal de Voz</label>
                <select id="sourceChannelSelect" class="w-full bg-slate-700 border border-slate-600 rounded text-white px-3 py-2" required>
                    <option value="">Selecciona...</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Prefijo</label>
                <input type="text" id="namePrefix" class="w-full bg-slate-700 border border-slate-600 rounded text-white px-3 py-2" placeholder="Patrulla" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">L√≠mite Usuarios</label>
                <input type="number" id="userLimit" class="w-full bg-slate-700 border border-slate-600 rounded text-white px-3 py-2" placeholder="0 = sin l√≠mite" min="0">
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-300 mb-2">Categor√≠a</label>
                <select id="categorySelect" class="w-full bg-slate-700 border border-slate-600 rounded text-white px-3 py-2">
                    <option value="">Sin categor√≠a</option>
                </select>
            </div>
            <div class="flex gap-3 pt-4">
                <button type="button" onclick="closeModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white px-4 py-2 rounded">Cancelar</button>
                <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">Guardar</button>
            </div>
        </form>
    </div>
</div>

<script>
    let editingId = null;
    let channels = [];
    let categories = [];

    document.addEventListener("DOMContentLoaded", () => {
        loadChannels();
        loadGenerators();
        loadActiveChannels();
        
        document.getElementById("addGeneratorBtn").addEventListener("click", openModal);
        document.getElementById("generatorForm").addEventListener("submit", handleSubmit);
        document.getElementById("refreshBtn").addEventListener("click", loadActiveChannels);
    });

    async function loadChannels() {
        try {
            const res = await fetch(`/api/guilds/${guildId}/channels`);
            const { data } = await res.json();
            channels = data.filter(c => c.type === 2);
            categories = data.filter(c => c.type === 4);
            updateSelects();
        } catch (error) {
            console.error(error);
        }
    }

    function updateSelects() {
        const select = document.getElementById("sourceChannelSelect");
        const catSelect = document.getElementById("categorySelect");
        
        select.innerHTML = '<option value="">Selecciona...</option>';
        channels.forEach(ch => {
            const opt = document.createElement("option");
            opt.value = ch.id;
            opt.textContent = `#${ch.name}`;
            select.appendChild(opt);
        });

        catSelect.innerHTML = '<option value="">Sin categor√≠a</option>';
        categories.forEach(cat => {
            const opt = document.createElement("option");
            opt.value = cat.id;
            opt.textContent = cat.name;
            catSelect.appendChild(opt);
        });
    }

    async function loadGenerators() {
        try {
            const res = await fetch("/api/guild-plugin/temp-channels/settings");
            const { data } = await res.json();

            const list = document.getElementById("generatorsList");
            if (data.generators.length === 0) {
                list.innerHTML = '<div class="text-center py-8 text-slate-400">No hay generadores</div>';
                return;
            }

            list.innerHTML = data.generators.map(gen => {
                const ch = channels.find(c => c.id === gen.sourceChannelId);
                return `
                    <div class="bg-slate-700 border border-slate-600 rounded-lg p-4 flex justify-between items-center">
                        <div>
                            <p class="font-bold text-white">${gen.namePrefix}</p>
                            <p class="text-sm text-slate-400">#${ch?.name || "desconocido"}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editGenerator('${JSON.stringify(gen).replace(/'/g, "&apos;")}' )" class="text-blue-400">‚úèÔ∏è</button>
                            <button onclick="deleteGenerator('${gen.sourceChannelId}')" class="text-red-400">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join("");
        } catch (error) {
            console.error(error);
        }
    }

    async function loadActiveChannels() {
        try {
            const res = await fetch("/api/guild-plugin/temp-channels/active");
            const { data } = await res.json();

            const list = document.getElementById("activeChannelsList");
            if (data.length === 0) {
                list.innerHTML = '<div class="text-center py-8 text-slate-400">No hay canales activos</div>';
                return;
            }

            list.innerHTML = data.map(ch => `
                <div class="bg-slate-700 border border-slate-600 rounded-lg p-3 flex justify-between items-center">
                    <div>
                        <p class="font-medium text-white">${ch.name}</p>
                        <p class="text-xs text-slate-400">üë• ${ch.members}/${ch.maxMembers || "‚àû"}</p>
                    </div>
                    <button onclick="deleteChannel('${ch.id}')" class="text-red-400">üóëÔ∏è</button>
                </div>
            `).join("");
        } catch (error) {
            console.error(error);
        }
    }

    function openModal() {
        editingId = null;
        document.getElementById("modalTitle").textContent = "Nuevo Generador";
        document.getElementById("generatorForm").reset();
        document.getElementById("modal").classList.remove("hidden");
    }

    function editGenerator(genStr) {
        const gen = JSON.parse(genStr);
        editingId = gen.sourceChannelId;
        document.getElementById("modalTitle").textContent = "Editar Generador";
        document.getElementById("sourceChannelSelect").value = gen.sourceChannelId;
        document.getElementById("namePrefix").value = gen.namePrefix;
        document.getElementById("userLimit").value = gen.userLimit || 0;
        document.getElementById("categorySelect").value = gen.parentCategoryId || "";
        document.getElementById("modal").classList.remove("hidden");
    }

    function closeModal() {
        document.getElementById("modal").classList.add("hidden");
    }

    async function handleSubmit(e) {
        e.preventDefault();
        const sourceChannelId = document.getElementById("sourceChannelSelect").value;
        const namePrefix = document.getElementById("namePrefix").value;
        const userLimit = parseInt(document.getElementById("userLimit").value) || 0;
        const parentCategoryId = document.getElementById("categorySelect").value;

        try {
            let res;
            if (editingId) {
                res = await fetch(`/api/guild-plugin/temp-channels/generator/${editingId}`, {
                    method: "PATCH",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ namePrefix, userLimit, parentCategoryId }),
                });
            } else {
                res = await fetch("/api/guild-plugin/temp-channels/generator", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ sourceChannelId, namePrefix, userLimit, parentCategoryId }),
                });
            }

            if (res.ok) {
                closeModal();
                loadGenerators();
            }
        } catch (error) {
            console.error(error);
        }
    }

    async function deleteGenerator(id) {
        if (!confirm("¬øEliminar?")) return;
        try {
            await fetch(`/api/guild-plugin/temp-channels/generator/${id}`, { method: "DELETE" });
            loadGenerators();
        } catch (error) {
            console.error(error);
        }
    }

    async function deleteChannel(id) {
        if (!confirm("¬øEliminar?")) return;
        try {
            await fetch(`/api/guild-plugin/temp-channels/channel/${id}`, { method: "DELETE" });
            loadActiveChannels();
        } catch (error) {
            console.error(error);
        }
    }

    document.getElementById("modal").addEventListener("click", (e) => {
        if (e.target.id === "modal") closeModal();
    });
</script>
