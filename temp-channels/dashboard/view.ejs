<section class="border-border bg-bg-panel rounded-lg border p-4 shadow-sm">
  <form
    x-data="{
      generators: [],
      activeChannels: [],
      openModal: false,
      editingId: null,
      channels: [],
      categories: [],
      formData: {
        sourceChannelId: '',
        namePrefix: '',
        userLimit: 0,
        parentCategoryId: ''
      },
      saving: false,
      loading: true,
      
      async loadData() {
        try {
          this.loading = true;
          const [settingsRes, activeRes] = await Promise.all([
            fetch(window.location.href),
            fetch(window.location.href + '/active')
          ]);
          
          if (settingsRes.ok) {
            const data = await settingsRes.json();
            this.generators = data.generators || [];
          }
          if (activeRes.ok) {
            const data = await activeRes.json();
            this.activeChannels = data || [];
          }
        } catch (error) {
          console.error('Error loading data:', error);
        } finally {
          this.loading = false;
        }
      },
      
      async loadChannels() {
        try {
          const guildId = window.location.pathname.split('/')[2];
          const res = await fetch(\`/dashboard/\${guildId}/api/channels\`);
          const data = await res.json();
          this.channels = data.filter(c => c.type === 0 || c.type === 2) || [];
          this.categories = data.filter(c => c.type === 4) || [];
        } catch (error) {
          console.error('Error loading channels:', error);
        }
      },
      
      openAddModal() {
        this.editingId = null;
        this.formData = { sourceChannelId: '', namePrefix: '', userLimit: 0, parentCategoryId: '' };
        this.openModal = true;
      },
      
      editGenerator(gen) {
        this.editingId = gen.sourceChannelId;
        this.formData = { ...gen };
        this.openModal = true;
      },
      
      async submitForm() {
        this.saving = true;
        try {
          const method = this.editingId ? 'PATCH' : 'POST';
          const url = this.editingId 
            ? window.location.href + '/generator/' + this.editingId
            : window.location.href + '/generator';
          
          const res = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(this.formData)
          });
          
          if (res.ok) {
            Alpine.store('toast').show('Guardado correctamente', 'success');
            this.openModal = false;
            await this.loadData();
          } else {
            throw new Error();
          }
        } catch (error) {
          Alpine.store('toast').show('Error al guardar', 'error');
        } finally {
          this.saving = false;
        }
      },
      
      async deleteGenerator(id) {
        if (!confirm('Â¿EstÃ¡s seguro?')) return;
        try {
          const res = await fetch(window.location.href + '/generator/' + id, { method: 'DELETE' });
          if (res.ok) {
            Alpine.store('toast').show('Eliminado correctamente', 'success');
            await this.loadData();
          }
        } catch (error) {
          Alpine.store('toast').show('Error al eliminar', 'error');
        }
      },
      
      async deleteChannel(id) {
        if (!confirm('Â¿EstÃ¡s seguro?')) return;
        try {
          const res = await fetch(window.location.href + '/channel/' + id, { method: 'DELETE' });
          if (res.ok) {
            Alpine.store('toast').show('Canal eliminado', 'success');
            await this.loadData();
          }
        } catch (error) {
          Alpine.store('toast').show('Error al eliminar canal', 'error');
        }
      },
      
      init() {
        this.loadData();
        this.loadChannels();
      }
    }"
    @submit.prevent="submitForm">
    
    <!-- Generadores -->
    <div class="mb-6">
      <div class="mb-4 flex items-center justify-between">
        <h3 class="text-text text-lg font-bold">Generadores de Canales</h3>
        <button type="button" @click="openAddModal()"
          class="bg-primary hover:bg-primary-dark focus:ring-primary inline-flex items-center rounded-lg px-3 py-2 text-sm font-medium text-white focus:outline-none focus:ring-4">
          <i class="fa-solid fa-plus mr-2"></i> AÃ±adir
        </button>
      </div>
      
      <div class="space-y-2" x-show="!loading">
        <template x-if="generators.length === 0">
          <p class="text-text-muted text-center py-6">No hay generadores configurados</p>
        </template>
        
        <template x-for="gen in generators" :key="gen.sourceChannelId">
          <div class="border-border bg-bg-interactive rounded-lg border p-4 flex items-center justify-between">
            <div>
              <p class="text-text font-bold" x-text="gen.namePrefix"></p>
              <p class="text-text-muted text-sm">
                <span x-text="channels.find(c => c.id === gen.sourceChannelId)?.name || 'desconocido'"></span>
                <template x-if="gen.userLimit > 0">
                  | LÃ­mite: <span x-text="gen.userLimit"></span>
                </template>
              </p>
            </div>
            <div class="flex gap-2">
              <button type="button" @click="editGenerator(gen)" class="text-primary hover:opacity-75 transition-opacity">
                <i class="fa-solid fa-edit"></i>
              </button>
              <button type="button" @click="deleteGenerator(gen.sourceChannelId)" class="text-red-500 hover:opacity-75 transition-opacity">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
        </template>
      </div>
      
      <div x-show="loading" class="text-center py-6">
        <i class="fa-solid fa-spinner fa-spin text-text-muted"></i>
      </div>
    </div>

    <!-- Canales Activos -->
    <div class="border-border mt-6 border-t pt-6">
      <h3 class="text-text mb-4 text-lg font-bold">Canales Activos</h3>
      
      <div class="space-y-2" x-show="!loading">
        <template x-if="activeChannels.length === 0">
          <p class="text-text-muted text-center py-6">No hay canales activos</p>
        </template>
        
        <template x-for="ch in activeChannels" :key="ch.id">
          <div class="border-border bg-bg-interactive rounded-lg border p-4 flex items-center justify-between">
            <div>
              <p class="text-text font-bold" x-text="ch.name"></p>
              <p class="text-text-muted text-sm">
                ðŸ‘¥ <span x-text="ch.members"></span>/<span x-text="ch.maxMembers || 'âˆž'"></span>
              </p>
            </div>
            <button type="button" @click="deleteChannel(ch.id)" class="text-red-500 hover:opacity-75 transition-opacity">
              <i class="fa-solid fa-trash"></i>
            </button>
          </div>
        </template>
      </div>
    </div>

    <!-- Footer -->
    <div class="border-border mt-6 flex items-center justify-between border-t pt-6">
      <div></div>
    </div>
  </form>

  <!-- Modal -->
  <div x-show="openModal" x-transition class="fixed inset-0 bg-black/50 flex items-center justify-center z-50" @click.away="openModal = false" style="display: none;">
    <div class="bg-bg-panel rounded-lg p-6 max-w-md w-full mx-4 shadow-xl border border-border">
      <h3 class="text-text text-xl font-bold mb-4">
        <span x-show="!editingId">Nuevo Generador</span>
        <span x-show="editingId">Editar Generador</span>
      </h3>
      
      <form @submit.prevent="submitForm" class="space-y-4">
        <div>
          <label class="text-text text-sm font-semibold mb-2 block">Canal de Voz</label>
          <select x-model="formData.sourceChannelId" required
            class="focus:border-primary focus:ring-primary border-border bg-bg-interactive text-text block w-full rounded-lg border p-2.5 shadow-sm sm:text-sm">
            <option value="">Selecciona un canal...</option>
            <template x-for="ch in channels.filter(c => c.type === 2)">
              <option :value="ch.id" x-text="'ðŸŽ¤ ' + ch.name"></option>
            </template>
          </select>
        </div>
        
        <div>
          <label class="text-text text-sm font-semibold mb-2 block">Prefijo de Nombre</label>
          <input type="text" x-model="formData.namePrefix" placeholder="ej: Patrulla" required
            class="focus:border-primary focus:ring-primary border-border bg-bg-interactive text-text block w-full rounded-lg border p-2.5 shadow-sm sm:text-sm">
        </div>
        
        <div>
          <label class="text-text text-sm font-semibold mb-2 block">LÃ­mite de Usuarios</label>
          <input type="number" x-model="formData.userLimit" min="0" max="99"
            class="focus:border-primary focus:ring-primary border-border bg-bg-interactive text-text block w-full rounded-lg border p-2.5 shadow-sm sm:text-sm">
          <div class="text-text-muted text-xs mt-1">0 = ilimitado</div>
        </div>
        
        <div>
          <label class="text-text text-sm font-semibold mb-2 block">CategorÃ­a (Opcional)</label>
          <select x-model="formData.parentCategoryId"
            class="focus:border-primary focus:ring-primary border-border bg-bg-interactive text-text block w-full rounded-lg border p-2.5 shadow-sm sm:text-sm">
            <option value="">Sin categorÃ­a</option>
            <template x-for="cat in categories">
              <option :value="cat.id" x-text="cat.name"></option>
            </template>
          </select>
        </div>
        
        <div class="flex gap-3 pt-4 border-border border-t">
          <button type="button" @click="openModal = false"
            class="border-border bg-bg-interactive text-text hover:opacity-75 flex-1 rounded-lg border px-4 py-2.5 font-medium transition-opacity">
            Cancelar
          </button>
          <button type="submit" :disabled="saving" :class="{'opacity-50': saving}"
            class="bg-primary hover:bg-primary-dark focus:ring-primary flex-1 rounded-lg px-4 py-2.5 font-medium text-white focus:outline-none focus:ring-4 transition-opacity">
            <i class="fa-solid fa-floppy-disk mr-2" x-show="!saving"></i>
            <i class="fa-solid fa-spinner fa-spin mr-2" x-show="saving"></i>
            <span x-show="!saving">Guardar</span>
            <span x-show="saving">Guardando...</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</section>
